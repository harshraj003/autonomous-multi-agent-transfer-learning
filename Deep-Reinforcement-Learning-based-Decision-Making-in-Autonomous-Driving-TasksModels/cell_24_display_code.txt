# CELL 20 – VIDEO DISPLAY & COMPREHENSIVE PLOTS
import os
import glob
import pandas as pd
import matplotlib.pyplot as plt
from IPython.display import Video, display, HTML
import numpy as np

video_dir = os.path.join(path_HW5, "Videos")
csv_path = os.path.join(path_HW5, "Data_Average_Reward", "final.csv")

# ----------------------------------------------------------------------
# 1. Display Videos
# ----------------------------------------------------------------------
print("="*60)
print("DEMO VIDEOS")
print("="*60)

# Find all EP*.mp4 videos
video_files = sorted(glob.glob(os.path.join(video_dir, "EP*-episode-0.mp4")))

if video_files:
    for vf in video_files:
        episode_name = os.path.basename(vf).split('-')[0]
        print(f"\n{episode_name}:")
        try:
            display(Video(vf, width=600))
        except Exception as e:
            print(f"  Could not display video: {e}")
            print(f"  Video path: {vf}")
else:
    print("\nNo video files found matching pattern 'EP*-episode-0.mp4'")
    print(f"Available videos in {video_dir}:")
    all_videos = glob.glob(os.path.join(video_dir, "*.mp4"))
    for v in all_videos[:5]:
        print(f"  - {os.path.basename(v)}")

# ----------------------------------------------------------------------
# 2. Load Results CSV
# ----------------------------------------------------------------------
print(f"\n{'='*60}")
print("RESULTS ANALYSIS")
print("="*60)

if not os.path.exists(csv_path):
    print(f"\nResults CSV not found at: {csv_path}")
    print("Please run Cell 19 first to generate the demo data.")
else:
    df = pd.read_csv(csv_path)
    
    # Display summary table
    print("\nSummary Table:")
    print(df.to_string(index=False))
    
    # ----------------------------------------------------------------------
    # 3. Plot 1: Alpha Evolution
    # ----------------------------------------------------------------------
    fig, ax = plt.subplots(figsize=(10, 6))
    
    ax.plot(df['episode'], df['alpha_b'], 'o-', label='Blue (F1)', linewidth=2, markersize=8)
    ax.plot(df['episode'], df['alpha_g'], 's-', label='Green (F2)', linewidth=2, markersize=8)
    ax.plot(df['episode'], df['alpha_y'], '^-', label='Yellow (F3)', linewidth=2, markersize=8)
    ax.plot(df['episode'], df['alpha_p'], 'd-', label='Purple (F4)', linewidth=2, markersize=8)
    
    # Add trust threshold lines
    ax.axhline(0.7, color='green', linestyle='--', alpha=0.5, label='High trust (0.7)')
    ax.axhline(0.5, color='gray', linestyle='--', alpha=0.5, label='Neutral (0.5)')
    ax.axhline(0.3, color='red', linestyle='--', alpha=0.5, label='Low trust (0.3)')
    
    ax.set_xlabel('Episode', fontsize=12)
    ax.set_ylabel('Alpha (Trust Level)', fontsize=12)
    ax.set_title('Trust Evolution per Follower Across Episodes', fontsize=14, fontweight='bold')
    ax.legend(loc='best', fontsize=10)
    ax.grid(True, alpha=0.3)
    ax.set_ylim(0, 1)
    
    plot1_path = os.path.join(path_HW5, 'Images', 'alpha_evolution.png')
    plt.savefig(plot1_path, dpi=300, bbox_inches='tight')
    plt.show()
    print(f"\nSaved plot 1 to: {plot1_path}")
    
    # ----------------------------------------------------------------------
    # 4. Plot 2: Safety Metrics
    # ----------------------------------------------------------------------
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 5))
    
    # Safe steps bar chart
    colors = ['#2ecc71' if not crash else '#e74c3c' for crash in df['crash']]
    bars = ax1.bar(df['episode'], df['safe_steps'], color=colors, edgecolor='black', linewidth=1.5)
    ax1.axhline(1500, color='blue', linestyle='--', alpha=0.6, label='Max steps (1500)')
    ax1.set_xlabel('Episode', fontsize=12)
    ax1.set_ylabel('Safe Steps', fontsize=12)
    ax1.set_title('Safe Steps per Episode', fontsize=14, fontweight='bold')
    ax1.legend(loc='best')
    ax1.grid(True, alpha=0.3, axis='y')
    
    # Add value labels on bars
    for bar in bars:
        height = bar.get_height()
        ax1.text(bar.get_x() + bar.get_width()/2., height,
                f'{int(height)}',
                ha='center', va='bottom', fontsize=10)
    
    # Crash status pie chart
    crash_counts = df['crash'].value_counts()
    labels = ['No Crash', 'Crashed'] if False in crash_counts.index else ['Crashed']
    sizes = [crash_counts.get(False, 0), crash_counts.get(True, 0)]
    colors_pie = ['#2ecc71', '#e74c3c']
    explode = (0.1, 0) if len(sizes) == 2 else (0,)
    
    ax2.pie(sizes, explode=explode, labels=labels, colors=colors_pie,
            autopct='%1.1f%%', shadow=True, startangle=90, textprops={'fontsize': 11})
    ax2.set_title('Crash Status Distribution', fontsize=14, fontweight='bold')
    
    plot2_path = os.path.join(path_HW5, 'Images', 'safety_metrics.png')
    plt.savefig(plot2_path, dpi=300, bbox_inches='tight')
    plt.show()
    print(f"Saved plot 2 to: {plot2_path}")
    
    # ----------------------------------------------------------------------
    # 5. Plot 3: Sync Events and Alpha Changes
    # ----------------------------------------------------------------------
    fig, ax = plt.subplots(figsize=(10, 6))
    
    # Calculate alpha changes between episodes
    alpha_cols = ['alpha_b', 'alpha_g', 'alpha_y', 'alpha_p']
    alpha_changes = []
    for i in range(1, len(df)):
        total_change = sum(abs(df[col].iloc[i] - df[col].iloc[i-1]) for col in alpha_cols)
        alpha_changes.append(total_change)
    
    if alpha_changes:
        episodes_for_change = df['episode'].iloc[1:].values
        ax.plot(episodes_for_change, alpha_changes, 'ro-', linewidth=2, markersize=10, label='Total α change')
        
        for i, (ep, change) in enumerate(zip(episodes_for_change, alpha_changes)):
            ax.text(ep, change, f'{change:.3f}', ha='center', va='bottom', fontsize=9)
    
    # Add sync count as bars
    ax2 = ax.twinx()
    ax2.bar(df['episode'], df['syncs'], alpha=0.3, color='blue', label='Sync events')
    
    ax.set_xlabel('Episode', fontsize=12)
    ax.set_ylabel('Total Alpha Change', fontsize=12, color='red')
    ax2.set_ylabel('Sync Events', fontsize=12, color='blue')
    ax.set_title('Alpha Changes and Sync Events per Episode', fontsize=14, fontweight='bold')
    
    ax.tick_params(axis='y', labelcolor='red')
    ax2.tick_params(axis='y', labelcolor='blue')
    
    ax.legend(loc='upper left')
    ax2.legend(loc='upper right')
    ax.grid(True, alpha=0.3)
    
    plot3_path = os.path.join(path_HW5, 'Images', 'alpha_changes_syncs.png')
    plt.savefig(plot3_path, dpi=300, bbox_inches='tight')
    plt.show()
    print(f"Saved plot 3 to: {plot3_path}")
    
    # ----------------------------------------------------------------------
    # 6. Final Summary Statistics
    # ----------------------------------------------------------------------
    print(f"\n{'='*60}")
    print("SUMMARY STATISTICS")
    print("="*60)
    
    print(f"\nTotal episodes: {len(df)}")
    print(f"Episodes without crash: {sum(~df['crash'])}/{len(df)}")
    print(f"Average safe steps: {df['safe_steps'].mean():.1f}")
    print(f"Total sync events: {df['syncs'].sum()}")
    
    print(f"\nFinal Alpha Values:")
    for follower, col in zip(['Blue (F1)', 'Green (F2)', 'Yellow (F3)', 'Purple (F4)'], alpha_cols):
        final_alpha = df[col].iloc[-1]
        initial_alpha = df[col].iloc[0]
        change = final_alpha - initial_alpha
        print(f"  {follower:15s}: {initial_alpha:.3f} → {final_alpha:.3f} (Δ = {change:+.3f})")
    
    print(f"\n{'='*60}")
